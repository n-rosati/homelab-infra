apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ganymede
  namespace: ganymede
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 15.4.15
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      # Default, not used since we override per workload
      repository: ghcr.io/zibbp/ganymede
      tag: "4.6.0"

    service:
      api:
        enabled: true
        ports:
          http:
            enabled: true
            port: 4000
            targetPort: 4000
      frontend:
        enabled: true
        ports:
          http:
            enabled: true
            port: 3000
            targetPort: 3000

    ingress:
      api:
        enabled: true
        ingressClassName: external
        hosts:
          - host: api.ganymede.${DOMAIN_BASE}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          certManager:
            enabled: true
            certificateIssuer: le-prod
      frontend:
        enabled: true
        ingressClassName: external
        hosts:
          - host: ganymede.${DOMAIN_BASE}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          certManager:
            enabled: true
            certificateIssuer: le-prod

    workload:
      api:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            main:
              image:
                repository: ghcr.io/zibbp/ganymede
                tag: "4.6.0"
              env:
                FRONTEND_HOST: https://ganymede.${DOMAIN_BASE}
                COOKIE_DOMAIN: ganymede.${DOMAIN_BASE}
                CDN_URL: https://cdn.ganymede.${DOMAIN_BASE}
                DB_HOST: "{{ .Values.cnpg.main.creds.host }}"
                DB_PORT: "5432"
                DB_USER: "{{ .Values.cnpg.main.user }}"
                DB_PASS: "{{ .Values.cnpg.main.password }}"
                DB_NAME: "{{ .Values.cnpg.main.database }}"
                DEFAULT_LOCALE: en
                TWITCH_CLIENT_ID: ${GANYMEDE_TWITCH_CLIENT_ID}
                TWITCH_CLIENT_SECRET: ${GANYMEDE_TWITCH_SECRET}
              ports:
                - name: http
                  containerPort: 4000
      frontend:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            main:
              image:
                repository: ghcr.io/zibbp/ganymede-frontend
                tag: "4.6.0"
              env:
                API_URL: https://api.ganymede.${DOMAIN_BASE}
                CDN_URL: https://cdn.ganymede.${DOMAIN_BASE}
              ports:
                - name: http
                  containerPort: 3000
