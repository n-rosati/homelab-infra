apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ganymede
  namespace: ganymede
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 15.4.15
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      # Default, not used since we override per workload
      repository: ghcr.io/zibbp/ganymede
      tag: "4.6.0"
    credentials:
      home-s3:
        name: home-s3
        type: s3
        url: ${S3_URL}
        bucket: ganymede
        encrKey: ${BACKUP_ENCRYPTION_KEY}
        accessKey: ${S3_ACCESS_KEY}
        secretKey: ${S3_SECRET_KEY}
    securityContext:
      container:
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
    persistence:
      videos:
        type: nfs
        enabled: true
        server: ${TRUENAS_IP}
        path: ${NFS_MEDIA_PATH}/Twitch
        mountPath: /data/videos
      config:
        enabled: true
        type: pvc
        mountPath: /data/config
        volsync:
          - name: uploads
            type: restic
            credentials: home-s3
            dest:
              enabled: false #CHANGE TO TRUE WHEN REINSTALLING APP
            src:
              enabled: true
              trigger:
                schedule: 15 0 * * *
      temp:
        enabled: true
        type: emptyDir
        mountPath: /data/temp
      logs:
        enabled: true
        type: emptyDir
        mountPath: /data/logs
    cnpg:
      main:
        enabled: true
        database: ganymede
        user: ganymede
        password: ${GANYMEDE_DB_PASSWORD}
        pgVersion: 16
        mode: standalone
        cluster:
          singleNode: true
        backups:
          enabled: true
          credentials: home-s3
        recovery:
          enabled: true
          credentials: home-s3
    service:
      api:
        enabled: true
        ports:
          api:
            enabled: true
            port: 4000
            targetPort: 4000
      main:
        enabled: true
        ports:
          main:
            enabled: true
            port: 3000
            targetPort: 3000
    ingress:
      api:
        enabled: true
        ingressClassName: external
        hosts:
          - host: api.ganymede.${DOMAIN_BASE}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          certManager:
            enabled: true
            certificateIssuer: le-prod
      main:
        enabled: true
        ingressClassName: external
        hosts:
          - host: ganymede.${DOMAIN_BASE}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          certManager:
            enabled: true
            certificateIssuer: le-prod
    workload:
      api:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            main:
              enabled: true
              primary: true
              image:
                repository: ghcr.io/zibbp/ganymede
                tag: "4.6.0"
              env:
                FRONTEND_HOST: https://ganymede.${DOMAIN_BASE}
                COOKIE_DOMAIN: ganymede.${DOMAIN_BASE}
                CDN_URL: https://cdn.ganymede.${DOMAIN_BASE}
                DB_HOST: "{{ .Values.cnpg.main.creds.host }}"
                DB_PORT: "5432"
                DB_USER: "{{ .Values.cnpg.main.user }}"
                DB_PASS: "{{ .Values.cnpg.main.password }}"
                DB_NAME: "{{ .Values.cnpg.main.database }}"
                DEFAULT_LOCALE: en
                TWITCH_CLIENT_ID: ${GANYMEDE_TWITCH_CLIENT_ID}
                TWITCH_CLIENT_SECRET: ${GANYMEDE_TWITCH_SECRET}
              ports:
                - name: http
                  containerPort: 4000
      main:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            main:
              probes:
                liveness:
                  enabled: true
                  type: http
                  path: /health
                readiness:
                  enabled: true
                  type: http
                  path: /health
                startup:
                  enabled: true
                  type: http
                  path: /health
              image:
                repository: ghcr.io/zibbp/ganymede-frontend
                tag: "4.6.0"
              env:
                API_URL: https://api.ganymede.${DOMAIN_BASE}
                CDN_URL: https://cdn.ganymede.${DOMAIN_BASE}
              ports:
                - name: http
                  containerPort: 3000
