apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jan
  namespace: mc-jan
spec:
  interval: 15m
  chart:
    spec:
      chart: minecraft-java
      version: 11.2.4
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  releaseName: jan
  values:
    global:
      stopAll: false
    image:
      repository: docker.io/itzg/minecraft-server
      tag: 2024.10.2-java17@sha256:db3ccc7db5371a7a4e7edf8696ccfa177f4b71a29ffbecc76e21a663d1bcf98d
      pullPolicy: Always
    webrcon-server:
      repository: docker.io/forewing/webrcon-server
      pullPolicy: IfNotPresent
      tag: 1.5.8@sha256:066c1e9abcea171c21b1e17c96fd7b339344a286e4a0650907279b93d102d5d2
    TZ: ${TIMEZONE}
    credentials:
      minio:
        name: minio
        type: s3
        accessKey: ${MINIO_ACCESS_KEY}
        bucket: ${MINIO_BUCKET_PREFIX}
        encrKey: ${BACKUP_ENCRYPTION_KEY}
        secretKey: ${MINIO_SECRET_KEY}
        url: ${MINIO_BUCKET_URL}
    addons:
      codeserver:
        enabled: true
        ingress:
          enabled: false
        service:
          ports:
            codeserver:
              port: 10353
          type: LoadBalancer
    mcbackup:
      backup_interval: 1h
      enabled: true
      excludes:
      - '*.jar'
      - cache
      - logs
      - '*.tmp'
      initial_delay: 2m
      link_latest: false
      pause_if_no_players: false
      player_online_check_interval: 5m
      prune_backups_days: 7
      tar_compress_method: gzip
      zstd_params:
      - --long=25
      - --single-thread
    persistence:
      data:
        enabled: true
        readOnly: false
        targetSelector:
          main:
            main:
              mountPath: /data
          mcbackup:
            mcbackup:
              mountPath: /data
              readOnly: true
        volsync:
        - credentials: minio
          name: minio
          type: restic
          dest:
            enabled: false
          src:
            enabled: false
      backups:
        enabled: true
        type: nfs
        path: /mnt/DSU/Backups/Minecraft/jan
        readOnly: false
        server: ${TRUENAS_IP}
        targetSelector:
          mcbackup:
            mcbackup:
              mountPath: /backups
    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ""
        ports:
          main:
            enabled: true
            port: ${JAN_GAME_PORT}
            protocol: tcp
          query:
            enabled: true
            port: ${JAN_GAME_PORT}
            protocol: udp
      rcon:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ""
        ports:
          rcon:
            enabled: true
            port: ${JAN_RCON_PORT}
      rcon-webserver:
        enabled: true
        type: LoadBalancer
        ports:
          rcon-webserver:
            enabled: true
            port: 8080
            protocol: http
    workload:
      main:
        replicas: 1
        type: Deployment
        podSpec:
          containers:
            main:
              env:
                ALLOW_NETHER: true
                ANNOUNCE_PLAYER_ACHIEVEMENTS: true
                DIFFICULTY: easy
                ENABLE_COMMAND_BLOCK: true
                ENABLE_QUERY: "true"
                EULA: true
                FABRIC_INSTALLER: ""
                FABRIC_INSTALLER_URL: ""
                FABRIC_LOADER_VERSION: 0.14.9
                FORCE_GAMEMODE: false
                FORCE_REDOWNLOAD: "false"
                GENERATE_STRUCTURES: true
                GENERATOR_SETTINGS: ""
                GUI: "FALSE"
                HARDCORE: false
                ICON: ""
                JVM_OPTS: ""
                JVM_XX_OPTS: ""
                LEVEL: world
                LEVEL_TYPE: DEFAULT
                MAX_BUILD_HEIGHT: 256
                MAX_PLAYERS: 2
                MAX_TICK_TIME: 60000
                MAX_WORLD_SIZE: 10000
                MEMORY: 3G
                MODE: survival
                MOTD: <3
                ONLINE_MODE: true
                OPS: SunnyEar4432867,Hydranoid620
                OVERRIDE_SERVER_PROPERTIES: true
                PACKWIZ_URL: ""
                PVP: true
                QUERY_PORT: '{{ .Values.service.main.ports.query.port }}'
                RCON_PASSWORD: ${MC_RCON_PASSWORD}
                RCON_PORT: '{{ .Values.service.rcon.ports.rcon.port }}'
                SEED: "-7497863297697545553"
                SERVER_PORT: '{{ .Values.service.main.ports.main.port }}'
                SPAWN_ANIMALS: true
                SPAWN_MONSTERS: true
                SPAWN_NPCS: true
                TYPE: FABRIC
                USE_AIKAR_FLAGS: true
                USE_FLARE_FLAGS: false
                USE_SIMD_FLAGS: true
                VERSION: 1.18.2
                VIEW_DISTANCE: 16
                WHITELIST: SunnyEar4432867,Hydranoid620
                WORLD: ""
                advanced: true
              imageSelector: image
              probes:
                liveness:
                  command:
                  - mc-health
                  enabled: true
                  type: exec
                readiness:
                  command:
                  - mc-health
                  enabled: true
                  type: exec
                startup:
                  command:
                  - mc-health
                  enabled: true
                  type: exec
      mcbackup:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            mcbackup:
              enabled: true
              env:
                BACKUP_INTERVAL: '{{ .Values.mcbackup.backup_interval }}'
                BACKUP_METHOD: tar
                DEST_DIR: '{{.Values.persistence.backups.mountPath }}'
                EXCLUDES: '{{ join "," .Values.mcbackup.excludes }}'
                INITIAL_DELAY: '{{ .Values.mcbackup.initial_delay }}'
                LINK_LATEST: '{{ .Values.mcbackup.link_latest }}'
                PAUSE_IF_NO_PLAYERS: '{{ .Values.mcbackup.pause_if_no_players }}'
                PLAYERS_ONLINE_CHECK_INTERVAL: '{{ .Values.mcbackup.player_online_check_interval }}'
                PRUNE_BACKUPS_DAYS: '{{ .Values.mcbackup.prune_backups_days }}'
                RCON_HOST: '{{ printf "%s-rcon" (include "tc.v1.common.lib.chart.names.fullname"
                  $) }}'
                RCON_PASSWORD: '{{
                  .Values.workload.main.podSpec.containers.main.env.RCON_PASSWORD
                  }}'
                RCON_PORT: '{{ .Values.service.rcon.ports.rcon.port }}'
                SERVER_PORT: '{{ .Values.service.main.ports.main.port }}'
                SRC_DIR: '{{.Values.persistence.data.mountPath }}'
                TAR_COMPRESS_METHOD: '{{ .Values.mcbackup.tar_compress_method }}'
                ZSTD_PARAMETERS: '{{ join " " .Values.mcbackup.zstd_params }}'
              imageSelector: mcBackupImage
              primary: true
              probes:
                liveness:
                  enabled: false
                readiness:
                  enabled: false
                startup:
                  enabled: false
      rcon-webserver:
        enabled: true
        type: Deployment
        podSpec:
          containers:
            rcon-webserver:
              imageSelector: webrcon-server
              enabled: true
              primary: true
              args:
              - '-addr {{ printf "%s-rcon" (include
                "tc.v1.common.lib.chart.names.fullname" $) }}:{{
                .Values.service.rcon.ports.rcon.port }}'
              - '-pass ${MC_RCON_PASSWORD}'
              - '-preset minecraft-default.json'
              probes:
                liveness:
                  enabled: false
                readiness:
                  enabled: false
                startup:
                  enabled: false
