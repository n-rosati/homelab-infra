name: Auto Rebase and Merge

on:
  schedule:
    # 6:37 AM EST = 10:37 UTC
    - cron: "37 10 * * *"
  workflow_dispatch:

jobs:
  rebase-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gh jq git

      - name: Authenticate gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth setup-git

      - name: Rebase and merge PRs with 'automerge' label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          prs=$(gh pr list --repo "$REPO" --label "automerge" --state open --json number --jq '.[].number')

          if [ -z "$prs" ]; then
            echo "No open PRs with label 'automerge'."
            exit 0
          fi

          for pr in $prs; do
            echo "Processing PR #$pr"
            
            branch=$(gh pr view "$pr" --repo "$REPO" --json headRefName --jq '.headRefName')

            echo "→ Rebasing branch $branch"
            git fetch origin
            git checkout "$branch"
            if git rebase origin/main; then
              echo "✅ Successfully rebased $branch"
              git push --force-with-lease origin "$branch"
              
              echo "→ Attempting merge..."
              gh pr merge "$pr" --repo "$REPO" --auto --merge || echo "⏳ Merge not ready yet (checks or approvals pending)"
            else
              echo "❌ Rebase failed for PR #$pr, aborting rebase"
              git rebase --abort || true
            fi
          done
