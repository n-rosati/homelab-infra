name: Auto Update and Merge

on:
  schedule:
    # 6:37 AM EST = 10:37 UTC
    - cron: "37 10 * * *"
  workflow_dispatch:

jobs:
  update-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth setup-git

      - name: Update and merge PRs with 'automerge' label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          prs=$(gh pr list --repo "$REPO" --label "automerge" --state open --json number --jq '.[].number')

          if [ -z "$prs" ]; then
            echo "No open PRs with label 'automerge'."
            exit 0
          fi

          for pr in $prs; do
            echo "Processing PR #$pr"

            echo "→ Updating branch with base"
            if gh pr update "$pr" --repo "$REPO" --update-branch; then
              echo "✅ Branch updated successfully"
            else
              echo "⚠️ Could not update branch (possible merge conflict)"
              continue
            fi

            echo "→ Attempting auto-merge"
            if gh pr merge "$pr" --repo "$REPO" --auto --merge; then
              echo "✅ Merge triggered for PR #$pr"
            else
              echo "⏳ Merge not ready yet (checks, approvals, or conflicts)"
            fi
          done
